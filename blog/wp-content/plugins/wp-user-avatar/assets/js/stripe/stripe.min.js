"use strict";!function($){(new function(){var e=this,t=Stripe(ppress_stripe_vars.publishable_key,{locale:ppress_stripe_vars.locale});this.init=function(){window.processCheckoutFlag=!1,window.confirmPaymentFlag=!1,$(document).on("ppress_updated_checkout",e.updated_checkout),$(document).on("ppress_update_checkout",e.unmountPaymentElement),$(document).on("click","#ppress-checkout-button",(function(){window.processCheckoutFlag=!0})),e.updatePaymentElement()},this.updated_checkout=function(t,n){e.checkout_form=$("form#ppress_mb_checkout_form"),e.checkout_form.on("ppress_checkout_place_order_stripe",e.validateFormSubmission),e.checkout_form.on("ppress_process_checkout_stripe",e.processCheckout),e.mountPaymentElement(n)},this.fieldValueOrEmpty=function(e){return e||""},this.getBillingDetails=function(){return{name:e.fieldValueOrEmpty($("#stripe-card_name").val()),email:e.fieldValueOrEmpty($("#ppmb_email").val()),phone:e.fieldValueOrEmpty($("#stripe_ppress_billing_phone").val()),address:{line1:e.fieldValueOrEmpty($("#stripe_ppress_billing_address").val()),line2:"",city:e.fieldValueOrEmpty($("#stripe_ppress_billing_city").val()),state:e.fieldValueOrEmpty($("#stripe_ppress_billing_state").val()),country:e.fieldValueOrEmpty($("#stripe_ppress_billing_country").val()),postal_code:e.fieldValueOrEmpty($("#stripe_ppress_billing_postcode").val())}}},this.updatePaymentElement=function(){$(document).on("change","#ppmb_email",(function(){e.unmountPaymentElement(),void 0!==window.elements.create&&(window.paymentElement=window.elements.create("payment",e.getPaymentOptions()),window.paymentElement.mount("#ppress-stripe-card-element"))}))},this.getPaymentOptions=function(){return{layout:{type:"tabs"},fields:{billingDetails:"true"===ppress_stripe_vars.hideBillingFields?"never":"auto"},defaultValues:{billingDetails:e.getBillingDetails()},terms:{card:"never"}}},this.mountPaymentElement=function(n){0!==$("#ppress-stripe-card-element").length&&(window.elements=t.elements(n.data.stripe_args),window.paymentElement=window.elements.create("payment",e.getPaymentOptions()),window.paymentElement.mount("#ppress-stripe-card-element"))},this.unmountPaymentElement=function(){0!==$("#ppress-stripe-card-element").length&&void 0!==window.paymentElement.destroy&&window.paymentElement.destroy()},this.validateFormSubmission=function(){if(!0===window.processCheckoutFlag)return window.processCheckoutFlag=!1,window.elements.submit().then((function(t){"error"in t&&void 0!==t.error.message?ppressCheckoutForm.createAlertMessage(t.error.message):e.checkout_form.submit()})),!1},this.processCheckout=function(n,s,i){if(!0===ppressCheckoutForm.is_var_defined(s.gateway_response)&&(!0===ppressCheckoutForm.is_var_defined(s.gateway_response.latest_invoice)&&!0===ppressCheckoutForm.is_var_defined(s.gateway_response.latest_invoice.payment_intent)&&!0===ppressCheckoutForm.is_var_defined(s.gateway_response.latest_invoice.payment_intent.status)||!0===ppressCheckoutForm.is_var_defined(s.gateway_response.status))){if(!1===window.confirmPaymentFlag){var r;window.confirmPaymentFlag=!0,r=ppressCheckoutForm.is_var_defined(s.gateway_response.client_secret)?s.gateway_response.client_secret:s.gateway_response.latest_invoice.payment_intent.client_secret;var o=e.getBillingDetails();t.confirmPayment({elements:window.elements,clientSecret:r,confirmParams:{return_url:s.order_success_url,payment_method_data:{billing_details:o}},redirect:"if_required"}).then((function(e){e.error?(window.confirmPaymentFlag=!1,ppressCheckoutForm.createAlertMessage(e.error.message)):("succeeded"===e.paymentIntent.status&&$(document.body).trigger("ppress_checkout_success",[s,i]),window.location.assign(s.order_success_url))}))}return!1}}}).init()}(jQuery);